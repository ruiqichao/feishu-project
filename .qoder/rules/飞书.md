---
trigger: model_decision
description: 更新飞书token配置时生效
---

# 飞书 user_access_token 获取与更新规则

## 功能概述

飞书 user_access_token 获取与更新功能允许用户通过 OAuth2 流程获取访问令牌，并支持令牌的定期更新和刷新。

## 核心组件

**令牌获取脚本**：
- `get_user_token.py` - 获取 user_access_token 的完整脚本
- 支持 OAuth2 授权码流程
- 包含本地 HTTP 服务器回调处理
- 支持权限范围指定

**令牌存储**：
- `token.json` - 存储获取到的访问令牌及相关信息
- 包含 access_token, token_type, expires_in, refresh_token 等字段

## 使用方法

### 1. 配置参数

在 `get_user_token.py` 中配置以下参数：

```python
CLIENT_ID = "your_app_client_id"
CLIENT_SECRET = "your_app_client_secret"
REDIRECT_URI = "http://localhost:9000/callback"
LOCAL_PORT = 9000
```

### 2. 指定权限范围

在构建授权 URL 时指定所需权限：

```python
params = {
    "client_id": CLIENT_ID,
    "redirect_uri": REDIRECT_URI,
    "response_type": "code",
    "state": state,
    "scope": "auth:user.id:read,docx:document,docx:document:write,docx:document:create,im:message:send_as_bot",
}
```

### 3. 运行令牌获取脚本

```bash
cd /path/to/feishu_project
python3 get_user_token.py
```

### 4. 令牌自动保存

获取到的令牌将自动保存到 `token.json` 文件中。

## 令牌更新流程

1. **定期检查过期时间**：监控 `expires_in` 字段确定令牌有效期
2. **使用刷新令牌**：当令牌即将过期时，使用 `refresh_token` 获取新令牌
3. **更新配置**：将新令牌更新到 MCP 配置中

## 权限管理

### 常用权限范围

- `auth:user.id:read` - 用户 ID 读取权限
- `docx:document` - 文档读取权限
- `docx:document:write` - 文档写入权限
- `docx:document:create` - 文档创建权限
- `im:message:send_as_bot` - 机器人消息发送权限

### 权限申请流程

1. 在飞书开放平台申请相应权限
2. 通过 OAuth2 流程获取包含所需权限的令牌
3. 验证权限是否生效

## 代码示例

### 令牌刷新实现

```python
def refresh_access_token(refresh_token: str) -> dict:
    """使用刷新令牌获取新访问令牌"""
    payload = {
        "grant_type": "refresh_token",
        "refresh_token": refresh_token,
        "client_id": CLIENT_ID,
        "client_secret": CLIENT_SECRET,
    }
    resp = requests.post(
        TOKEN_URL,
        json=payload,
        headers={"Content-Type": "application/json; charset=utf-8"},
    )
    resp.raise_for_status()
    return resp.json()
```

## 最佳实践

- 定期更新访问令牌，避免过期
- 妥善保管客户端密钥和访问令牌
- 在生产环境中使用 HTTPS 回调地址
- 实施令牌缓存机制以减少重复请求
- 监控 API 调用频率，避免超出限流限制

## 故障排除

- **授权失败**：检查 CLIENT_ID 和 CLIENT_SECRET 是否正确
- **回调失败**：确保 REDIRECT_URI 与飞书开放平台配置一致
- **权限不足**：确认在飞书开放平台已申请所需权限
- **令牌过期**：使用 refresh_token 获取新令牌

## 安全注意事项

- 不要在客户端代码中暴露 CLIENT_SECRET
- 使用安全的随机数生成 state 参数以防止 CSRF 攻击
- 在生产环境中使用适当的令牌存储和加密机制
